<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="js/jquery-2.1.3.min.js"></script> -->
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <title>iDEA PiCKS</title>
</head>

<body>
    <header>
        <h1>iDEA PiCKS</h1>
    </header>

    <!-- コンテンツ表示 -->
    <main>
        <template>
            <div id="app">
              <header class="header">
                <h1>Chat</h1>
                <!-- ログイン時にはフォームとログアウトボタンを表示 -->
                <div v-if="user.uid" key="login">
                  [{{ user.displayName }}]
                  <button type="button" @click="doLogout">ログアウト</button>
                </div>
                <!-- 未ログイン時にはログインボタンを表示 -->
                <div v-else key="logout">
                  <button type="button" @click="doLogin">ログイン</button>
                </div>
              </header>
          
              <!--Firebase から取得したリストを描画（トランジション付き）-->
              <transition-group name="chat" tag="div" class="list content">
                <section v-for="{ key, name, image, message } in chat" :key="key" class="item">
                  <div class="item-image"><img :src="image" width="40" height="40"></div>
                  <div class="item-detail">
                    <div class="item-name">{{ name }}</div>
                    <div class="item-message">
                      <nl2br tag="div" :text="message"/>
                    </div>
                  </div>
                </section>
              </transition-group>
            
              <!-- 入力フォーム -->
              <form action="" @submit.prevent="doSend" class="form">
                <textarea
                  v-model="input"
                  :disabled="!user.uid"
                  @keydown.enter.exact.prevent="doSend"></textarea>
                <button type="submit" :disabled="!user.uid" class="send-button">Send</button>
              </form>
            </div>
          </template>
    </main>
    <!-- コンテンツ表示 -->

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- JQuery -->

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- Vue.js -->


    <!--** 以下Firebase **-->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved } 
        from "https://www.gstatic.com/firebasejs/9.8.1/firebase-database.js";
        import { getAuth, signInWithPopup, onAuthStateChanged, signInAnonymously, GoogleAuthProvider, createUserWithEmailAndPassword} from "https://www.gstatic.com/firebasejs/9.8.1/firebase-auth.js"
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
    
        // Your web app's Firebase configuration
        const firebaseConfig = {
        apiKey: "AIzaSyCoVq-wxmzQ5XkDUjPjDdz2sHSvgGtNpt0",
        authDomain: "gsdemo-c9fc4.firebaseapp.com",
        projectId: "gsdemo-c9fc4",
        storageBucket: "gsdemo-c9fc4.appspot.com",
        messagingSenderId: "590008651385",
        appId: "1:590008651385:web:1a925d3c30272bd1fa4ea8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);// 最初にfirebase使う準備
        const db = getDatabase(app);// RealTimeDB使うよ

        // ここで、dbのどこから何のデータを取ってくるのかを考える
        // const dbRef = ref(db,"idea");// RTDB内の"idea"内のデータをdbRefとする

        const provider = new firebase.auth.TwitterAuthProvider()
        firebase.auth().signInWithPopup(provider)

        firebase.auth().signOut()

        // オブザーバーの登録
        firebase.auth().onAuthStateChanged(user => {
        // ログイン状態ならuserが取得できる
        this.user = user ? user : {}
        })



        // firebase モジュール
        import firebase from 'firebase'
        // 改行を <br> タグに変換するモジュール
        import Nl2br from 'vue-nl2br'
        export default {
        components: { Nl2br },
        data() {
            return {
            user: {},  // ユーザー情報
            chat: [],  // 取得したメッセージを入れる配列
            input: ''  // 入力したメッセージ
            }
        },
        created() {
            firebase.auth().onAuthStateChanged(user => {
            this.user = user ? user : {}
            const ref_message = firebase.database().ref('message')
            if (user) {
                this.chat = []
                // message に変更があったときのハンドラを登録
                ref_message.limitToLast(10).on('child_added', this.childAdded)
            } else {
                // message に変更があったときのハンドラを解除
                ref_message.limitToLast(10).off('child_added', this.childAdded)
            }
            })
        },
        methods: {
            // ログイン処理
            doLogin() {
            const provider = new firebase.auth.TwitterAuthProvider()
            firebase.auth().signInWithPopup(provider)
            },
            // ログアウト処理
            doLogout() {
            firebase.auth().signOut()
            },
            // スクロール位置を一番下に移動
            scrollBottom() {
            this.$nextTick(() => {
                window.scrollTo(0, document.body.clientHeight)
            })
            },
            // 受け取ったメッセージをchatに追加
            // データベースに新しい要素が追加されると随時呼び出される
            childAdded(snap) {
            const message = snap.val()
            this.chat.push({
                key: snap.key,
                name: message.name,
                image: message.image,
                message: message.message
            })
            this.scrollBottom()
            },
            doSend() {
            if (this.user.uid && this.input.length) {
                // firebase にメッセージを追加
                firebase.database().ref('message').push({
                message: this.input,
                name: this.user.displayName,
                image: this.user.photoURL
                }, () => {
                this.input = '' // フォームを空にする
                })
            }
            }
        }
        }



</script>
    <footer>
        <h4>iDEA PiCKS</h4>
    </footer>

</body>
</html>


